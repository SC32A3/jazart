"use strict";function gswaFramework(){this.init()}gswaFramework.do={},gswaFramework.preview={},gswaFramework.actions={},gswaFramework.default={bpm:120,nbTracks:42},gswaFramework.listCallbacks=["undo","redo","pushAction","popAction","bpm","play","pause","stop","saveOrDiscard","loadComposition","addTrackBefore","removeTrack","currentTime","addSource","removeSource","fillSource","loadingSource","loadSource","unloadSource","playSource","stopSource","stopAllSources","endedSource","addSample","removeSample","selectSample","unselectSample","sampleWhen","sampleDuration","sampleWaveform","sampleToTrack"],gswaFramework.prototype.init=function(){var t,e=function(){};this.isPlaying=this.isPaused=!1,this.on={},this.actions=[],this.cmparr=this.compositions=[],this.srcarr=this.sources=[],this.trkarr=this.tracks=[],this.selectedSamples=[],this.numberOfSourcesPlaying=0,this.sampleGroup=new gswaSampleGroup,this.undo=this.undo.bind(this),this.redo=this.redo.bind(this),this._frame=this._frame.bind(this);for(t in gswaFramework.do)this.do[t]=gswaFramework.do[t].bind(this);gswaFramework.listCallbacks.forEach(function(t){this.on[t]=e},this)},gswaFramework.prototype.run=function(){this.ctx=new AudioContext,this.gain=this.ctx.createGain(),this.analyser=this.ctx.createAnalyser(),this.destination=this.ctx.createGain(),this.gain.connect(this.ctx.destination),this.analyser.connect(this.gain),this.destination.connect(this.analyser),this._reset(),this._frame()},gswaFramework.prototype.reset=function(){var t=this;return new Promise(function(e,s){var o=t.currentComposition;o&&!o._needSave?t.on.saveOrDiscard(o,e,s):e()}).then(this._reset.bind(this))},gswaFramework.prototype.do=function(t,e,s,o,a){var r,i,n=gswaFramework.do[t];if(n){if(i=n.call(this,e,s,o,a)){for(r=this.actions.length-this.actionsInd-1;r-- >0;)this.on.popAction(this.actions.pop());return++this.actionsInd,this.actions.push(i),i.type=t,i.userData=this.on.pushAction(i),i.do()}}else console.warn('gswaFramework.do: "'+t+'" is invalid.')},gswaFramework.prototype.redo=function(){if(this.actionsInd+1<this.actions.length){var t=this.actions[++this.actionsInd];this.on.redo(t),t.do()}},gswaFramework.prototype.undo=function(){if(this.actionsInd>-1){var t=this.actions[this.actionsInd--];this.on.undo(t),t.undo()}},gswaFramework.prototype.preview=function(t,e,s,o,a){var r=gswaFramework.preview[t];r?(this._ptype!==t&&(this._ptype&&this.cancelPreview(),this._ptype=t,this._pdat0=e,this._pdat1=s,this._pdat2=o,this._pdat3=a),r(e,s,o,a)):console.warn('gswaFramework.preview: "'+t+'" is invalid.')},gswaFramework.prototype.cancelPreview=function(){var t,e=this._ptype;if(e)switch(t=this["_"+e].bind(this),delete this._ptype,e){case"moveSamples":case"croprightSamples":case"cropleftSamples":case"slipSamples":return t(this._pdat0,-this._pdat1,-this._pdat2);case"bpm":return t(this.bpm)}},gswaFramework.prototype.confirmPreview=function(){this._ptype&&(this.do(this._ptype,this._pdat0,this._pdat1,this._pdat2,this._pdat3),delete this._ptype)},gswaFramework.prototype.newComposition=function(){var t=this;this.reset().then(function(){var e={};t.on.loadComposition(e)})},gswaFramework.prototype.play=function(){this.isPlaying||(this.isPaused=!1,this.isPlaying=!0,this.on.play())},gswaFramework.prototype.pause=function(){this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this.on.pause())},gswaFramework.prototype.stop=function(){(this.isPlaying||this.isPaused)&&(this.isPlaying=this.isPaused=!1,this.on.pause())},gswaFramework.prototype.currentTime=function(t){return arguments.length?(t=Math.max(0,Math.min(t,this.sampleGroup.duration)),void this.on.currentTime(t)):0},gswaFramework.prototype.playSource=function(t){var e=this,s=t.start();return++this.numberOfSourcesPlaying,s._onended=function(){--e.numberOfSourcesPlaying,e.on.endedSource(t)},s.addEventListener("ended",s._onended),this.on.playSource(t),s},gswaFramework.prototype.stopSource=function(t){var e=t.bufferSources[0];e&&(e.removeEventListener("ended",e._onended),t.stop(),this.on.stopSource(t),e._onended())},gswaFramework.prototype.stopAllSources=function(){this.sources.forEach(this.stopSource,this),this.on.stopAllSources()},gswaFramework.prototype._frame=function(){this._reqFrameId=requestAnimationFrame(this._frame)},gswaFramework.prototype._reset=function(){var t=this.actions,e=this.tracks.length-gswaFramework.default.nbTracks;for(this.stop(),this.currentTime(0),this.currentComposition=null;t.length>0;)this.on.popAction(t.pop());if(this.actionsInd=-1,this.sampleGroup.samples.forEach(this.on.removeSample),this.sampleGroup.empty(),this._bpm(gswaFramework.default.bpm,!0),this.tracks.forEach(function(t){t.samples.length=0}),e<0)for(;e++<0;)this._addTrackBefore({},null);else for(;e-- >0;)this._removeTrack({})},gswaFramework.prototype._minmaxBpm=function(t){return Math.max(1,Math.min(t,999.999))},gswaFramework.prototype._minmaxDuration=function(t,e){return e&&t.reduce(e<0?function(t,e){return Math.max(t,-e.duration)}:function(t,e){return Math.min(t,e.buffer.duration-e.duration)},e)},gswaFramework.prototype._minmaxSlip=function(t,e){return e&&t.reduce(e<0?function(t,e){return Math.max(t,-e.offset)}:function(t,e){return Math.min(t,e.buffer.duration-e.offset)},e)},gswaFramework.prototype._minmaxTracks=function(t,e){var s=this.tracks.length-1;return!e||s<1?0:t.reduce(e<0?function(t,e){return-Math.min(-t,e.trkobj.id)}:function(t,e){return Math.min(t,s-e.trkobj.id)},e)},gswaFramework.prototype._minmaxWhen=function(t,e){return e>=0?e:t.reduce(function(t,e){return Math.max(t,-e.when)},e)},gswaFramework.prototype._bpm=function(t,e){this.on.bpm(t),e&&(this.bpm=t,this.sampleGroup.setBpm(t))},gswaFramework.prototype._addSource=function(t){this.sources.push(t),t.numberOfSampleInstances=0,t.userData=this.on.addSource(t),t.data&&this._fillSource(t,t.data),t._wasLoaded&&(delete t._wasLoaded,this._loadSource(t))},gswaFramework.prototype._addSources=function(t){t.forEach(this._addSource,this)},gswaFramework.prototype._removeSource=function(t){if(0===t.numberOfSampleInstances)return t.buffer&&(t._wasLoaded=!0,this._unloadSource(t)),this.sources.splice(this.sources.indexOf(t),1),this.on.removeSource(t),t},gswaFramework.prototype._removeSources=function(t){t.forEach(this._removeSource,this)},gswaFramework.prototype._fillSource=function(t,e){t.setData(e),this.on.fillSource(t,e),t.numberOfSampleInstances&&this._loadSource(t)},gswaFramework.prototype._fillSources=function(t,e){t.forEach(function(t,s){this._fillSource(t,e[s])},this)},gswaFramework.prototype._loadSource=function(t){var e=this;if(t.data)return t.setContext(this.ctx),t.connect(this.destination),this.on.loadingSource(t),t.load().then(function(){return e.on.loadSource(t),t})},gswaFramework.prototype._loadSources=function(t){return Promise.all(t.map(this._loadSource,this))},gswaFramework.prototype._unloadSource=function(t){t.data&&(t.unload(),this.on.unloadSource(t))},gswaFramework.prototype._unloadSources=function(t){t.forEach(this._unloadSource,this)},gswaFramework.prototype._addTrackBefore=function(t,e){var s=this.tracks;e?(s.splice(s.indexOf(e),0,t),s.forEach(function(t,e){t.id=e})):t.id=s.push(t)-1,t._attached=!0,t._trackAfter=e||null,t.name=t.name||"",t.samples=[],t.userData=this.on.addTrackBefore(t,t._trackAfter)},gswaFramework.prototype._removeTrack=function(t){var e=this.tracks;t._trackAfter?(e.splice(e.indexOf(t),1),e.forEach(function(t,e){t.id=e})):e.pop(),delete t._attached,delete t._trackAfter,this.on.removeTrack(t)},gswaFramework.prototype._nameTrack=function(t,e){t.name=e,this.on.nameTrack(t,e)},gswaFramework.prototype._addSamples=function(t){this.sampleGroup.addSamples(t),this.sampleGroup.update(),t.forEach(function(t){var e=t.source,s=e.buffer,o=t.duration,a=t.offset,r=this.sampleGroup.bpm/60;o=Number.isFinite(o)?o:e.duration,o*=s?r:1,a*=s?r:1,++e.numberOfSampleInstances,t.selected=!1,t.userData=this.on.addSample(t),t.wasSelected&&(this._selectSample(t),delete t.wasSelected),this.on.sampleWhen(t,t.when),this.on.sampleDuration(t,o),s&&this.on.sampleWaveform(t,s,a,o),this.on.sampleToTrack(t,t.track),t.track.samples.push(t)},this)},gswaFramework.prototype._removeSamples=function(t){this.sampleGroup.removeSamples(t),this.sampleGroup.update(),t.forEach(function(t){--t.source.numberOfSampleInstances,t.selected&&(this._unselectSample(t),t.wasSelected=!0),this.on.removeSample(t)},this)},gswaFramework.prototype._cropleftSamples=function(t,e,s){t.forEach(function(t){var o=t.source.buffer,a=Math.max(0,t.offset-e),r=t.duration+e;this.on.sampleDuration(t,r),o&&this.on.sampleWaveform(t,o,a,r),s&&(t.offset=a,t.duration=r)},this),s&&this.sampleGroup.update()},gswaFramework.prototype._croprightSamples=function(t,e,s){t.forEach(function(t){var o=t.source.buffer,a=t.offset,r=t.duration+e;this.on.sampleDuration(t,r),o&&this.on.sampleWaveform(t,o,a,r),s&&(t.duration=r)},this),s&&this.sampleGroup.update()},gswaFramework.prototype._moveSamples=function(t,e,s,o){t.forEach(function(t){var a=t.trkobj,r=this.tracks[a.id+s],i=t.when+e;this.on.sampleWhen(t,i),this.on.sampleToTrack(t,r),o&&(t.when=i,r!==a&&(a&&a.smparr.splice(a.smparr.indexOf(t),1),t.trkobj=r,r.smparr.push(t)))},this),o&&this.sampleGroup.update()},gswaFramework.prototype._slipSamples=function(t,e,s){t.forEach(function(t){var o=t.source.buffer,a=t.offset+e,r=t.duration;this.on.sampleDuration(t,r),o&&this.on.sampleWaveform(t,o,a,r),s&&(t.offset=a)},this),s&&this.sampleGroup.update()},gswaFramework.prototype._selectSample=function(t){t.selected=!0,this.selectedSamples.push(t),this.on.selectSample(t)},gswaFramework.prototype._selectSamples=function(t){t.forEach(this._selectSample,this)},gswaFramework.prototype._unselectSample=function(t){t.selected=!1,this.selectedSamples.splice(this.selectedSamples.indexOf(t),1),this.on.unselectSample(t)},gswaFramework.prototype._unselectSamples=function(t){t.forEach(this._unselectSample,this)},gswaFramework.preview.bpm=function(t){this._bpm(this._pdat0=this._minmaxBpm(t))},gswaFramework.preview.cropleftSamples=function(t,e){this.pdat1=this._minmaxDuration(t,this.pdat1+e),this._cropleftSamples(t,this.pdat1)},gswaFramework.preview.croprightSamples=function(t,e){this.pdat1=this._minmaxDuration(t,this.pdat1+e),this._croprightSamples(t,this.pdat1)},gswaFramework.preview.moveSamples=function(t,e,s){this._pdat1=this._minmaxWhen(t,this._pdat1+e),this._pdat2=this._minmaxTracks(t,this._pdat2+s),this._moveSamples(t,this._pdat1,this._pdat2)},gswaFramework.preview.slipSamples=function(t,e){this._pdat1=this._minmaxSlip(t,this._pdat1+e),this._slipSamples(t,this._pdat1)},gswaFramework.do.addSamples=function(t){return{do:this._addSamples.bind(this,t),undo:this._removeSamples.bind(this,t)}},gswaFramework.do.addSources=function(t){return t=t.map(function(t){var e=new gswaBufferSample;return t.constructor===File?e.setData(t):(e.duration=t.duration,e.filename=t.filename,e.name=t.name),e}),{do:this._addSources.bind(this,t),undo:this._removeSources.bind(this,t)}},gswaFramework.do.addTrackBefore=function(t,e){return{do:this._addTrackBefore.bind(this,t,e),undo:t._attached?this._addTrackBefore.bind(this,t,t._trackAfter):this._removeTrack.bind(this,t)}},gswaFramework.do.bpm=function(t){if(t!==this.bpm)return{do:this._bpm.bind(this,this._minmaxBpm(t),!0),undo:this._bpm.bind(this,this.bpm,!0)}},gswaFramework.do.cropleftSamples=function(t,e){if(e=this._minmaxDuration(t,e))return{do:this._cropleftSamples.bind(this,t,e,!0),undo:this._cropleftSamples.bind(this,t,-e,!0)}},gswaFramework.do.croprightSamples=function(t,e){if(e=this._minmaxDuration(t,e))return{do:this._croprightSamples.bind(this,t,e,!0),undo:this._croprightSamples.bind(this,t,-e,!0)}},gswaFramework.do.loadSources=function(t){return{do:this._loadSources.bind(this,t),undo:this._unloadSources.bind(this,t)}},gswaFramework.do.moveSamples=function(t,e,s){if(e=this._minmaxWhen(t,e),s=this._minmaxTracks(t,s),e||s)return{do:this._moveSamples.bind(this,t,e,s,!0),undo:this._moveSamples.bind(this,t,-e,-s,!0)}},gswaFramework.do.nameTrack=function(t,e){return{do:this._nameTrack.bind(this,t,e),undo:this._nameTrack.bind(this,t,t.name)}},gswaFramework.do.removeSamples=function(t){return{do:this._removeSamples.bind(this,t),undo:this._addSamples.bind(this,t)}},gswaFramework.do.removeSources=function(t){return{do:this._removeSources.bind(this,t),undo:this._addSources.bind(this,t)}},gswaFramework.do.removeTrack=function(t){return{do:this._removeTrack.bind(this,t),undo:this._addTrackBefore.bind(this,t,t._trackAfter)}},gswaFramework.do.selectSamples=function(t){return{do:this._selectSamples.bind(this,t),undo:this._unselectSamples.bind(this,t)}},gswaFramework.do.slipSamples=function(t,e){if(e=this._minmaxSlip(t,e))return{do:this._slipSamples.bind(this,t,e,!0),undo:this._slipSamples.bind(this,t,-e,!0)}},gswaFramework.do.unselectAllSamples=function(){var t=this.selectedSamples;if(t.length>0)return t=t.slice(),{do:this._unselectSamples.bind(this,t),undo:this._selectSamples.bind(this,t)}},gswaFramework.do.unselectSamples=function(t){return{do:this._unselectSamples.bind(this,t),undo:this._selectSamples.bind(this,t)}};