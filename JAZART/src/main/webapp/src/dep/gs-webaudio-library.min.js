"use strict";function gswaSampleGroup(){this.id=++gswaSampleGroup.id,this.parents={},this.samples=[],this.samplesRev=[],this._onendedResolve=[],this.setBpm(60)}window.gswaBufferSample=function(){this.bufferSources=[]},gswaBufferSample.regFilename=/(?:([^\/]*)\.([a-zA-Z\d]*))?$/,gswaBufferSample.prototype={setContext:function(t){this.ctx=t},setData:function(t){if(t){var e,n=t.name||t;this.data=t,"string"==typeof n&&(e=gswaBufferSample.regFilename.exec(n),this.filename=e[0],this.name=e[1])}},load:function(){var t=this.data;return t instanceof AudioBuffer?Promise.resolve(this._setDataFromAudioBuffer(t)):t instanceof ArrayBuffer?this._setDataFromArrayBuffer(t):t instanceof Blob?this._setDataFromBlob(t):this._setDataFromURL(t)},unload:function(){this.stop(),this.disconnect(),this.buffer=null},connect:function(t){this.connectedTo=t,this.bufferSources.forEach(function(e){e.connect(t)})},disconnect:function(){this.connectedTo=null,this.bufferSources.forEach(function(t){t.disconnect()})},start:function(t,e,n){var s,i=this.ctx,r=this.buffer;if(i&&r)return s=i.createBufferSource(),s.buffer=r,s.onended=this._removeSource.bind(this,s),s.connect(this.connectedTo),this.bufferSources.push(s),s.start(t||0,e||0,arguments.length>2?n:this.duration),s},stop:function(){this.bufferSources.forEach(function(t){t.onended=null,t.stop()}),this.bufferSources.length=0},_removeSource:function(t){this.bufferSources.splice(this.bufferSources.indexOf(t),1)},_setDataFromAudioBuffer:function(t){return this.buffer=t,this.duration=t.duration,t},_setDataFromArrayBuffer:function(t){return this.ctx.decodeAudioData(t).then(this._setDataFromAudioBuffer.bind(this))},_setDataFromBlob:function(t){var e=this,n=new FileReader;return new Promise(function(s,i){n.onloadend=function(){s(e._setDataFromArrayBuffer(n.result))},n.readAsArrayBuffer(t)})},_setDataFromURL:function(t){return fetch(t).then(function(t){return t.arrayBuffer()}).then(this._setDataFromArrayBuffer.bind(this))}},function(){function t(t,e){for(var n=0,s=0,i=t.length+e.length,r=new Float32Array(i);n<i;)r[n++]=t[s],r[n++]=e[s++];return r}function e(t,e,n){for(var s=0;s<n.length;++s)t.setUint8(e+s,n.charCodeAt(s))}function n(t,e,n){for(var s,i=0;i<n.length;++i,e+=2)s=Math.max(-1,Math.min(n[i],1)),t.setInt16(e,s<0?32768*s:32767*s,!0)}function s(t,e,n){for(var s=0;s<n.length;++s,e+=4)t.setFloat32(e,n[s],!0)}window.gswaEncodeWAV=function(i,r){var a=i.numberOfChannels,o=i.sampleRate,u=r&&r.float32?3:1,f=3===u?32:16,h=f/8,c=a*h,l=2===a?t(i.getChannelData(0),i.getChannelData(1)):i.getChannelData(0),d=new ArrayBuffer(44+l.length*h),p=new DataView(d);return e(p,0,"RIFF"),p.setUint32(4,36+l.length*h,!0),e(p,8,"WAVE"),e(p,12,"fmt "),p.setUint32(16,16,!0),p.setUint16(20,u,!0),p.setUint16(22,a,!0),p.setUint32(24,o,!0),p.setUint32(28,o*c,!0),p.setUint16(32,c,!0),p.setUint16(34,f,!0),e(p,36,"data"),p.setUint32(40,l.length*h,!0),(1===u?n:s)(p,44,l),d}}(),gswaSampleGroup.id=0,gswaSampleGroup.prototype={setContext:function(t){this.ctx=t},setBpm:function(t){this.bpm!==t&&(this.bpm=t,this.bps=t/60,this.samples.forEach(function(e){e.source instanceof gswaSampleGroup&&e.source.setBpm(t)}),this._updateDur())},empty:function(){var t=this.id;this.samples.forEach(function(e){delete e.source.parents[t]}),this.samples.length=0,this.samplesRev.length=0,this.update()},start:function(t,e,n){var s=this;return new Promise(function(i){s._onendedResolve.push(i),setTimeout(i,1e3*s._start(t,e,n))})},stop:function(){this.samples.forEach(function(t){t.source.stop()}),this._onendedResolve.forEach(function(t){t()}),this._onendedResolve.length=0},addSample:function(t){var e=t.source.parents,n=this.id;e&&(e[n]?++e[n].nb:e[n]={obj:this,nb:1}),t.offset=t.offset||0,this.samples.push(t),this.samplesRev.push(t)},addSamples:function(t){t.forEach(this.addSample.bind(this))},removeSample:function(t){var e=t.source.parents,n=this.samples.indexOf(t);n>0&&(e&&--e[this.id].nb<=0&&delete e[this.id],this.samples.splice(n,1),this.samplesRev.splice(this.samplesRev.indexOf(t),1))},removeSamples:function(t){t.forEach(this.removeSample.bind(this))},update:function(){var t=this.parents;this._sortSmp(),this._updateDur();for(var e in t)t[e].obj.update()},_start:function(t,e,n){var s=this.bps,i=this.duration;return i&&(t=t>0?t:this.ctx.currentTime,e=(e||0)/s,n=i=(null!=n?n:i)/s,this.samples.forEach(function(i){var r=i.source,a=r instanceof gswaSampleGroup,o=i.when/s-e,u=i.offset,f=null!=i.duration?i.duration:r.duration;a&&(u/=s,f/=s),o<0&&(u-=o,f+=o),f+=Math.min(n-o-f,0),f>0&&(o=t+Math.max(0,o),a?r._start(o,u*s,f*s):r.start(o,u,f))})),i},_updateDur:function(){var t=this.samplesRev[0];this.duration=t?this._beatEnd(t):0},_sortSmp:function(){function t(t,e){return t<e?-1:t>e?1:0}var e=this;this.samples.sort(function(e,n){return t(e.when,n.when)}),this.samplesRev.sort(function(n,s){return t(e._beatEnd(s),e._beatEnd(n))})},_beatEnd:function(t){var e=t.source,n=null!=t.duration?t.duration:e.duration;return t.when+(e._beatEnd?n:n*this.bps)}};